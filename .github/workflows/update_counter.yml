# .github/workflows/update_counter.yml

name: Update Visit Counter

on:
  push:
    branches:
      - main # OU o nome da sua branch principal (master/main)
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Initialize and Fetch Counter
        id: count_fetch
        run: |
          # A CHAVE DEVE SER SÓ O DOMÍNIO + CAMINHO (sem https://)
          DOMAIN_KEY="nataliaberbetviana.github.io"
          
          # --- NOVO: TENTA CRIAR/INICIALIZAR O CONTADOR ---
          # Esta chamada garante que o contador exista.
          echo "Inicializando contador se necessário..."
          curl -s -X GET "https://api.countapi.xyz/create?namespace=${DOMAIN_KEY}&key=visits&value=0" > /dev/null
          
          # --- FIM NOVO ---
          
          # 1. URL para buscar o valor atual
          COUNT_URL="https://api.countapi.xyz/get/${DOMAIN_KEY}/visits"
          
          echo "Buscando contador em: $COUNT_URL"
          
          # Salva a resposta da API (que é um JSON com {"value": N})
          RESPONSE=$(curl -s $COUNT_URL)
          
          # Verifica se a resposta contém um JSON válido com o campo 'value'
          COUNT=$(echo $RESPONSE | jq -r '.value' 2>/dev/null)

          if [ -z "$COUNT" ] || [ "$COUNT" = "null" ]; then
            echo "::error::Falha ao obter valor do contador, API retornou erro ou JSON inválido."
            # Se a inicialização falhou e a busca falhou, paramos o Action com erro
            exit 1 
          fi
          
          echo "Contagem atual: $COUNT"
          
          # Cria o arquivo visits.json que seu JS irá ler
          echo "{\"count\": $COUNT}" > visits.json
        
      - name: Commit and Push new visits.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_files: visits.json 
          commit_message: "chore(ci): Atualiza contador de visualizações (Automático)"
          commit_author: GitHub Actions <actions@github.com>
