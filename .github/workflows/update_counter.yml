# .github/workflows/update_counter.yml

name: Update Visit Counter

on:
  push:
    branches:
      - main # OU o nome da sua branch principal (master/main)
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch and Update Counter (Robust)
        id: count_fetch
        run: |
          # A CHAVE DEVE SER SÓ O DOMÍNIO + CAMINHO (sem https://)
          # SUBSTITUA SE NECESSÁRIO
          DOMAIN_KEY="nataliaberbetviana.github.io"
          
          # URL DE HIT: Incrementa o contador e retorna o JSON com o valor atual
          HIT_URL="https://api.countapi.xyz/hit/${DOMAIN_KEY}/visits"
          
          echo "Fazendo HIT na API: $HIT_URL"
          
          # Faz o HIT e salva a resposta JSON
          RESPONSE=$(curl -s $HIT_URL)
          
          echo "Resposta da API: $RESPONSE"

          # Tenta extrair o valor do JSON. 
          # Usamos o Python para garantir que o JSON seja processado corretamente, 
          # eliminando a chance de erro do 'jq' se o JSON for inválido.
          COUNT=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('value', 0))")

          if [ -z "$COUNT" ] || [ "$COUNT" = "0" ]; then
            echo "::warning::Contagem pode estar zero ou falhou. Verifique a chave."
            # Definimos um valor 0 para não quebrar, mas alertamos sobre o problema.
            COUNT=0
          fi
          
          echo "Contagem final: $COUNT"
          
          # Cria o arquivo visits.json que seu JS irá ler
          echo "{\"count\": $COUNT}" > visits.json
        
      - name: Commit and Push new visits.json
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_files: visits.json 
          commit_message: "chore(ci): Atualiza contador de visualizações (Automático)"
          commit_author: GitHub Actions <actions@github.com>
